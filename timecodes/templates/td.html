{% load static %}
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title></title>
  <link rel="stylesheet" type="text/css" href="{% static 'css/hbguy.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.min.css" />
</head>

<body>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-resize/1.1/jquery.ba-resize.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/stickybits@3.7.9/dist/stickybits.min.js"></script>
	<script src="https://d3js.org/d3.v7.min.js"></script>
	<script src="https://unpkg.com/dom-autoscroller@2.2.3/dist/dom-autoscroller.js"></script>

	<main>
		<nav class="navbar navbar-expand-lg navbar-light bg-light tdNav">
	  <div class="container-fluid">
			<h1 id="tdh1"><img src="{% static 'belyashik.png' %}" id="Icon" width="50px" height="50px"></h1>
			<h3 id="editableTitle">{{ title }} <button id="edit" onclick="toggleEdit()"><img src="{% static 'edit.png' %}" width="20px" height="20px"></button></h3>
	  </div>
	</nav>
    <div class="container" id="container">
      <table>
        <thead>
        <tbody id="fields">
          {% if length == 0 %}
          <tr>
            <td><input type="tel" id="timecode0" name="timecode0" maxlength="8" value="00:00" class="tc"></td>
            <td><textarea id="text0" name="text0" rows="1" oninput="autoGrowTextarea(this)"></textarea></td>
            <td><button class="delete"><img src="{% static 'delete.png' %}" width="50px" height="50px"></button>
            	<button id="pauseButton"><img src="{% static 'addcode.png' %}" width="50px" height="50px"></button>
            	<button class="drag"><img src="{% static 'drag.png' %}" width="30px" height="30px"></button>
          </tr>
          {% else %}
            {% for i, j in data %}
		  <tr>
              <td><input type="tel" id="timecode{{ forloop.counter0 }}" name="timestamps{{ forloop.counter0 }}" class="tc" maxlength="8" value="{{ i }}"></td>
              <td><textarea id="text{{ forloop.counter0 }}" name="texts{{ forloop.counter0 }}" rows="1" oninput="autoGrowTextarea(this)">{{ j }}</textarea></td>
              <td><button class="delete"><img src="{% static 'delete.png' %}" width="50px" height="50px"></button>
              	  <button id="pauseButton"><img src="{% static 'addcode.png' %}" width="50px" height="50px"></button>
              	  <button class="drag"><img src="{% static 'drag.png' %}" width="30px" height="30px"></button>
            </tr>
            {% endfor %}
          {% endif %}
        </tbody>
      </table>
      <div class="buttons">
        <button id="addRow"><img src="{% static 'plus.png' %}" width="50px" height="50px"></button>
        <button id="copy"><img src="{% static 'copy.png' %}" width="50px" height="50px"></button>
        <form action="" method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="hidden" id="editableTitle" name="title">
          <input type="hidden" id="timestamps-field" name="timestamps_field">
          <input type="hidden" id="texts-field" name="texts_field">
          <input type="hidden" id="video-Id" name="video_Id">
        </form>
        <button id="save"><img src="{% static 'save.png' %}" width="50px" height="50px"></button>
        <a href="{% url 'home' %}">
        	<button id="gohome"><img src="{% static 'home.png' %}" width="50px" height="50px"></button>
        </a>
        <button id="lesina"><img src="{% static 'lesina.png' %}" width="50px" height="50px"></button>
        <button id="changeTime"><img src="{% static 'time.png' %}" width="50px" height="50px"></button>
        <button id="video"><img src="{% static 'video.png' %}" width="50px" height="50px"></button>
      </div>
      <form class="hidden" id="timeForm">
		  <label for="timeInput">–£–≤–µ–ª–∏—á–∏—Ç—å/—É–º–µ–Ω—å—à–∏—Ç—å –≤—Ä–µ–º—è –¥–ª—è –≤—Å–µ—Ö —Ç–∞–π–º–∫–æ–¥–æ–≤</label>
		  <input type="tel" id="timeInput" pattern="^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]$" required>
		  <div id="buttons">
			  <button type="button" id="submitTime" onclick="incrementTime()">+</button>
			  <button type="button" id="submitTime" onclick="incrementTime(false)">-</button>
		  </div>
	  </form>
      <div class="pics hidden"><img src="{% static 'rzvrt.gif' %}"></div>
      <div class="pic hidden"><img src="{% static 'veralesina1.gif' %}"></div>
      <div class="frameOverlay"></div>
			<div class="draggable resizable" id="wrapper">
			  <img id="resize" src="{% static 'resize.jpg' %}" width="20px" height="20px">
			  <img id="resizeHeight" src="{% static 'resizeHeight.png' %}" width="20px" height="15px">
			  <img id="move" src="{% static 'move.png' %}" width="20px" height="12px">
			  <div class="handle" id="player"></div>
			  <div class="input-container">
			    <button id="changeLink" onclick="showInputField()"><img src="{% static 'linkchanger.png' %}" width="25px" height="25px"></button>
			    <div id="inputFieldContainer">
			      <input type="text" id="videoInput" name="video_input" placeholder="–ù–æ–≤–∞—è —é—Ç—É–±-—Å—Å—ã–ª–∫–∞" style="display: none;">
			      <button type="button" id="updateButton" onclick="updatePlayer()" style="display: none;"><img src="{% static 'sendlink.png' %}" width="25px" height="25px"></button>
			    </div>
			  </div>
			</div>
      <div id="characterCountDisplay">Total character count: </div>
    </div>
  </main>
  {% if user.is_authenticated %}
		<script>
		const container = document.getElementById("fields");
		const addRowButton = document.getElementById("addRow");
		const textarea = document.getElementById("text0");
		let rowNum = 1; // –Ω–æ–º–µ—Ä –ø–µ—Ä–≤–æ–π –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏
		var player = null;
		var playerElement = document.querySelector('#player');
		var wrapper = document.querySelector('#wrapper');
		playerElement.style.display = "none";
		resize.style.display = "none";
		resizeHeight.style.display = "none";
		move.style.display = "none";
		changeLink.style.display = "none";

		document.querySelector("#video").addEventListener("click", e => {
		    if (document.querySelector('#player').style.display === "none") {
		        // Load the YouTube IFrame API script if it hasn't been loaded already
		        if (!window.YT) {
		            var tag = document.createElement('script');
		            tag.src = "https://www.youtube.com/iframe_api";
		            var firstScriptTag = document.getElementsByTagName('script')[0];
		            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
		        } else {
		            // If the API script is already loaded, create the player immediately
		            onYouTubeIframeAPIReady();
		        }
		        // Show the player
		        
		        document.querySelector('#player').style.display = "flex";
		        wrapper.style.display = "flex";
		        changeLink.style.display = "block";	   
		        resize.style.display = "none";
		        resizeHeight.style.display = "none";
		        move.style.display = "none";     
		    } else {
	        player.stopVideo();
	    		document.querySelector('#player').style.display = "none"; 
	    		wrapper.style.display = "none";
	    		changeLink.style.display = "none";  
	    		resize.style.display = "none";
	    		resizeHeight.style.display = "none";
	        move.style.display = "none";		
	    	} 
		});

		document.querySelector("#changeLink").addEventListener("click", e => {
			  const videoInput = document.querySelector("#videoInput");
			  const updateButton = document.querySelector("#updateButton");

			  if (videoInput.style.display === "none") {
			  	inputFieldContainer.style.display = "flex";
			    videoInput.style.display = "initial";
			    updateButton.style.display = "initial";
			  } else {
			    videoInput.style.display = "none";
			    updateButton.style.display = "none";
			  }
		}); 

		document.addEventListener("DOMContentLoaded", function() {
		  interact('#wrapper')
		    .draggable({
		      inertia: true,
		      modifiers: [
		        interact.modifiers.restrictRect({
		          restriction: 'window',
		          endOnly: true
		        })
		      ],
		      listeners: {
		        start(event) {
		          $('.frameOverlay').show();
		          disableScroll(); // Disable page scrolling
		        },
		        move(event) {
		          const target = event.target;
				  const rect = target.getBoundingClientRect();
				  const targetWidth = rect.width;
				  const targetHeight = rect.height;
				  const minX = 0;
				  const maxX = window.innerWidth - targetWidth;
				  const maxY = window.innerHeight - targetHeight;

				  const x = parseFloat(target.getAttribute('data-x')) || 0; // Use current x position
				  const y = Math.max(Math.min(maxY, (parseFloat(target.getAttribute('data-y')) || 0) + event.dy));

				  target.style.transform = `translate(${x}px, ${y}px)`;
				  target.setAttribute('data-x', x);
				  target.setAttribute('data-y', y);
		        },
		        end(event) {
		          $('.frameOverlay').hide();
		          enableScroll(); // Enable page scrolling
		        }
		      }
		    })
		    // .resizable({
		    //   edges: { left: true, right: true, bottom: true, top: true },
		    //   listeners: {
		    //     start(event) {
		    //       $('.frameOverlay').show();
		    //       disableScroll(); // Disable page scrolling
		    //     },
		    //     move(event) {
		    //       const target = event.target;
		    //       const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.deltaRect.left;
		    //       const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.deltaRect.top;

		    //       target.style.width = event.rect.width + 'px';
		    //       target.style.height = event.rect.height + 'px';
		    //       target.style.transform = 'translate(' + x + 'px,' + y + 'px)';

		    //       target.setAttribute('data-x', x);
		    //       target.setAttribute('data-y', y);
		    //     },
		    //     end(event) {
		    //       $('.frameOverlay').hide();
		    //       enableScroll(); // Enable page scrolling
		    //     }
		    //   }
		    // })
		    // .styleCursor({
		    //   left: 'w-resize',
		    //   right: 'e-resize',
		    //   top: 'n-resize',
		    //   bottom: 's-resize',
		    //   topLeft: 'nw-resize',
		    //   topRight: 'ne-resize',
		    //   bottomLeft: 'sw-resize',
		    //   bottomRight: 'se-resize'
		    // });

		  function disableScroll() {
		    document.addEventListener('touchmove', preventScroll, { passive: false });
		  }

		  function enableScroll() {
		    document.removeEventListener('touchmove', preventScroll);
		  }

		  function preventScroll(event) {
		    event.preventDefault();
		  }
		});

    document.querySelectorAll("#pauseButton").forEach(button => {
        button.addEventListener("click", e => {
          var tr = e.currentTarget.parentElement.parentElement;
          var input = tr.querySelector("input");
          if (input) {
            var player = onYouTubeIframeAPIReady();
            var newCurrentTime = formatTime(player.getCurrentTime());

            // Check if the input value is not empty
            if (input.value.trim() !== '') {
              // Parse the input value to a float
              var savedTime = parseFloat(input.value);

              // Update the input value with the new current time
              input.value = newCurrentTime;

            } else {
              // If the input is empty, just set the input value to the new current time
              input.value = newCurrentTime;
            }
          }
          saveForm(e);
        });
      });

		document.addEventListener('DOMContentLoaded', function() {
		  var wrapperElement = document.querySelector('#wrapper');

		  stickybits(wrapperElement, {
		    stickyBitStickyOffset: 0, // Set the offset to 0
		    verticalPosition: 'bottom', // Stick element to the bottom
		    useGetBoundingClientRect: true,
		  });
		});
		document.querySelectorAll(".tc").forEach(i => {
					  	if (i.value.split(":")[0] == "00" && i.value.split(":").length == 3) {
						  	i.value = i.value.slice(3);
						  }
					  });
		addRowButton.addEventListener("click", function() {
		    	addNewRow();
		  });
		document.querySelector('#changeTime').addEventListener("click", e => {
			document.querySelector("#timeForm").classList.toggle("hidden");
			if (!document.querySelector("#timeForm").classList.contains("hidden"))
			{
				document.querySelector("#timeForm").style.display = "flex";
			}
			else {
				document.querySelector("#timeForm").style.display = "none";
			}
		});

		document.querySelector("#save").addEventListener("click", e => {
		  		document.querySelector(".pics").classList.toggle("hidden");
		  		saveForm(e);
		  });
	  document.querySelector("#lesina").addEventListener("click", e => {
				document.querySelector(".pic").classList.toggle("hidden");
		  });
		document.querySelectorAll("input")[document.querySelectorAll("textarea").length-1].focus();
		document.querySelectorAll("textarea").forEach(i => {
		  		i.style.height = "5px";
		    	i.style.height = (i.scrollHeight) + "px";
		  });
		document.querySelectorAll(".delete").forEach(i => {
		  		i.addEventListener("click", deleteRow)
		  		i.addEventListener("click", saveForm)
		  });
		for (var i = 1; i < document.querySelectorAll("textarea").length; i++) {
		  		addSuggestions(document.querySelectorAll("textarea")[i]);
		  		autoGrowTextarea(document.querySelectorAll("textarea")[i]);
		  }
		document.querySelectorAll("input").forEach(i => {
		    	//i.addEventListener("change", saveForm);
		    	i.addEventListener("keydown", e => {
		    		if(e.currentTarget.value.length == 8 || e.key === "Enter" || e.key === "Tab") {
				  		e.currentTarget.value += "";
				    	// setTimeout(() => {
					  	// 	i.parentElement.parentElement.querySelector("textarea").focus();
						// }, 0);
						return true;
			    	}
			  		if (!(e.keyCode >= 48 && e.keyCode <= 57 || e.keyCode >= 96 && e.keyCode <= 105 || e.keyCode === 8)){
				    	e.preventDefault();
				    }
			    	const regex = /^[0-9:]+$/; // —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ
			  		if(!regex.test(e.currentTarget.value)){ // –µ—Å–ª–∏ —Å–∏–º–≤–æ–ª—ã –Ω–µ —è–≤–ª—è—é—Ç—Å—è —Ü–∏—Ñ—Ä–∞–º–∏ –∏–ª–∏ –¥–≤–æ–µ—Ç–æ—á–µ–º
					    e.currentTarget.value = e.currentTarget.value.slice(0, -1); // —É–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–∏–º–≤–æ–ª –∏–∑ –∑–Ω–∞—á–µ–Ω–∏—è input
					    return false; // –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏, —á—Ç–æ–±—ã –≤–≤–µ–¥–µ–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω–µ
			  		}
					// –¥–æ–±–∞–≤–ª—è–µ–º –¥–≤–æ–µ—Ç–æ—á–∏–µ –∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ü–∏—Ñ—Ä
					if ((e.currentTarget.value.length === 2 || e.currentTarget.value.length === 5) && e.keyCode !== 8) {
					    e.currentTarget.value += ":";
			  		} else if (e.currentTarget.value.length > 8) {
			    		e.currentTarget.value = e.currentTarget.value.slice(0, 8);
			  		} else if ((e.currentTarget.value.length === 3 || e.currentTarget.value.length === 6) && e.keyCode === 8){
			    		const inputValueArray = e.currentTarget.value.split('');
			    		inputValueArray.splice(-1, 1);
			    		e.currentTarget.value = inputValueArray.join('');
			  		}
			  		return true; // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º true, —á—Ç–æ–±—ã –≤–≤–µ–¥–µ–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª –æ—Ç–æ–±—Ä–∞–∑–∏–ª—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω–µ
				});
	    });
		document.querySelector("#copy").addEventListener("click", e => {
			    let text = "";
			    document.querySelectorAll("tr").forEach(tr => {
			        text += tr.querySelector("input").value + " " + tr.querySelector("textarea").value + "\n";
			    });

		        // Use Clipboard API if available
		        navigator.clipboard.writeText(text)
		            .then(() => {
		                alert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!");
		            })
		            .catch((error) => {
		                // Fallback for unsupported browsers (e.g., mobile browsers)
				        const input = document.createElement("textarea");
				        input.value = text;
				        document.body.appendChild(input);
				        input.select();

				        try {
				            // Execute copy command
				            document.execCommand("copy");
				            alert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!");
				        } catch (err) {
				            alert("–ù–ï –°–ö–û–ü–ò–†–û–í–ê–ù–û!" + " " + "err");
				        }

		        document.body.removeChild(input);
		            });
			});

		document.querySelectorAll("tr").forEach(i => {
		  			i.addEventListener("change", saveForm);
		  			});
		document.querySelectorAll("tr")[0].querySelector(".delete").style.display = "none";
		document.querySelectorAll("tr")[0].querySelector(".drag").style.display = "none";
		document.querySelectorAll("tr")[0].querySelector("#pauseButton").style.display = "none";

		document.addEventListener("DOMContentLoaded", qwerty);
		//qwerty();

		addFirstSuggestions(textarea);
    calculateSigns();
		
		function addFirstSuggestions(textarea) {
		  	const suggestions = ['–ó–∞—Å—Ç–∞–≤–∫–∞', '–ú—É–∑—ã–∫–∞', '–ó–∞—Å—Ç–∞–≤–∫–∞, –º—É–∑—ã–∫–∞', '–ú—É–∑—ã–∫–∞, –∑–∞—Å—Ç–∞–≤–∫–∞', "–ó–∞—Å—Ç–∞–≤–∫–∞ –∏ –º—É–∑—ã–∫–∞", "–ú—É–∑—ã–∫–∞ –∏ –∑–∞—Å—Ç–∞–≤–∫–∞", "–ó–∞—Å—Ç–∞–≤–∫–∞ —Å –º—É–∑—ã–∫–æ–π", "–ú—É–∑—ã–∫–∞ —Å –∑–∞—Å—Ç–∞–≤–∫–æ–π"];
		    suggestions.sort();
		    const suggestionsList = document.createElement('ul');
		    suggestionsList.id = "popups";
		    suggestionsList.style.display = 'none';
		    container.appendChild(suggestionsList);

		    textarea.addEventListener('input', function() {
		      const inputText = this.value.toLowerCase();
		      suggestionsList.innerHTML = '';
		      if (!suggestions.filter(suggestion => suggestion.toLowerCase().startsWith(inputText)).length) {
					suggestionsList.style.display = 'none';
				}
			    else {
			    	suggestionsList.style.display = 'block';
			    	var rect = textarea.getBoundingClientRect();
			    	//console.log(rect.top + document.body.scrollTop);
			    	suggestionsList.style.top = rect.top + document.body.scrollTop + "px";
			    	suggestionsList.style.left = rect.left + document.body.scrollLeft + "px";
			    }
		      suggestions.filter(suggestion => suggestion.toLowerCase().startsWith(inputText)).forEach(suggestion => {
		        const li = document.createElement('li');
		        li.innerText = suggestion;

		        li.addEventListener('click', function() {
		          textarea.value = this.innerText;
		          suggestionsList.style.display = 'none';
		          textarea.focus();
		          autoGrowTextarea(textarea);
		   		  saveForm(new Event("click"));
		        });
		        suggestionsList.appendChild(li);
		        document.addEventListener('click', (e) => {
					if (!textarea.contains(e.target)) {
					    suggestionsList.style.display = 'none';
					  	}
					});
		        if (!suggestion.toLowerCase().startsWith(inputText)) suggestionsList.style.display = 'none';
			    else {
			    	suggestionsList.style.display = 'block';
			    	var rect = textarea.getBoundingClientRect();
			    	console.log(rect.top + document.body.scrollTop);
			    	suggestionsList.style.top = rect.top + document.body.scrollTop + "px";
			    	suggestionsList.style.left = rect.left + document.body.scrollLeft + "px";
			    }
		      });
		    });
		    container.appendChild(suggestionsList);
        calculateSigns();
		    //autoGrowTextarea(textarea);
		  };
		function addSuggestions(newTextarea) {
		    const suggestions = ['–ò—Ç–æ–≥–∏ –æ–ø—Ä–æ—Å–∞ –ø—Ä–æ ', '–ò—Ç–æ–≥–∏ –æ–ø—Ä–æ—Å–∞ –æ ', '–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞ –Ω–æ–≤—ã–π —Ñ–∏–ª—å–º', '–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞ –∫—Ä–∏–Ω–∂', '–ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ', '–•–∏–Ω—à—Ç–µ–π–Ω vs. –ï—Ñ–∞–Ω–æ–≤:', '–•–∏–Ω—à—Ç–µ–π–Ω –ø—Ä–æ—Ç–∏–≤ –ï—Ñ–∞–Ω–æ–≤–∞:', '¬´–ß—Ç–æ –∫—É–ø–∏—Ç—å –≤ –°–∞–º–∞—Ä–µ?¬ª: ', '–ß—Ç–æ –∫—É–ø–∏—Ç—å –≤ –°–∞–º–∞—Ä–µ?: ', '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –†–ó–í–†–¢: ', '–ù–æ–≤–æ—Å—Ç–∏ –†–æ—Å—Å–∏–∏ ', '–ù–æ–≤–æ—Å—Ç–∏ –°–∞–º–∞—Ä—ã ', "–ù–æ–≤–æ—Å—Ç–∏ –£–∫—Ä–∞–∏–Ω—ã ", "–ù–æ–≤–æ—Å—Ç–∏ –º–∏—Ä–∞ ", "–ù–æ–≤–æ—Å—Ç—å –û–º—Å–∫–∞: ", "–ù–æ–≤–æ—Å—Ç—å –∏–∑ –û–º—Å–∫–∞: ", "–û–¥–Ω–∞ –Ω–æ–≤–æ—Å—Ç—å –∏–∑ –û–º—Å–∫–∞: ", '–ù–∞—á–∞–ª–æ', "–ü—Ä–æ—â–∞–Ω–∏–µ –∏ ", "–ü—Ä–æ—â–∞–Ω–∏–µ –∏ –ø–µ—Å–Ω—è", "–ü–µ—Å–Ω—è", "–ü—Ä–æ—â–∞–Ω–∏–µ", "–ß–∞—Ç: ", "–î–æ–Ω–∞—Ç—ã", "–î–æ–Ω–∞—Ç—ã, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞–Ω–∞–ª–∞", "–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞–Ω–∞–ª–∞", "–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞–Ω–∞–ª–∞, –¥–æ–Ω–∞—Ç—ã", "–£–≥–æ–ª–æ–∫ –ø—Ä–æ–ø–∞–≥–∞–Ω–¥–∏—Å—Ç–∞: ", "–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –†–ó–í–†–¢: –ò–≥–æ—Ä—å –°–∞–∂–∏–Ω –æ", "–ß–∞—Ç: –ø—Ä–æ ", "–ï—â–µ –ø—Ä–æ ", "–ï—â—ë –ø—Ä–æ", "–ü–æ–¥–≤–æ–¥–∫–∞ –∫ —Ä–∞–∑–≥–æ–≤–æ—Ä—É —Å ", "–†–∞–∑–≥–æ–≤–æ—Ä —Å", "–ù–æ–≤–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –∑–∞—Å–ª—É–∂–∏–ª–∏", "–ü–ª–∞–Ω —ç—Ñ–∏—Ä–∞", "–ù–∞—á–∞–ª–æ, –ø–ª–∞–Ω —ç—Ñ–∏—Ä–∞", "–ù–∞—á–∞–ª–æ, –ø–ª–∞–Ω —ç—Ñ–∏—Ä–∞, –≥–µ–æ–ø–µ—Ä–µ–∫–ª–∏—á–∫–∞", "–ì–µ–æ–ø–µ—Ä–µ–∫–ª–∏—á–∫–∞", "–£—Ä–æ–∫ –≥–µ–æ–≥—Ä–∞—Ñ–∏–∏", "–ì–µ–æ–≥—Ä–∞—Ñ–∏—è —Å–ª—É—à–∞—Ç–µ–ª–µ–π", "–ì–µ–æ–≥—Ä–∞—Ñ–∏—è –†–ó–í–†–¢", '–ù–æ–≤–æ—Å—Ç–∏ –†–æ—Å—Å–∏–∏: ', '–ù–æ–≤–æ—Å—Ç–∏ –°–∞–º–∞—Ä—ã: ', "–ù–æ–≤–æ—Å—Ç–∏ –£–∫—Ä–∞–∏–Ω—ã: ", "–ù–æ–≤–æ—Å—Ç–∏ –º–∏—Ä–∞: ", "–ù–∞—á–∞–ª–æ, –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, –ø–ª–∞–Ω —ç—Ñ–∏—Ä–∞", "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ ", "–°—Ü–µ–Ω–∞ –ø–æ—Å–ª–µ —Ç–∏—Ç—Ä–æ–≤", "–ë–æ–Ω—É—Å", "–°—Ç–∏—Ö–æ—Ç–≤–æ—Ä–µ–Ω–∏–µ –°–µ—Ä–≥–µ—è –õ–µ–π–±–≥—Ä–∞–¥–∞", "–°—Ç–∏—Ö–∏ –°–µ—Ä–≥–µ—è –õ–µ–π–±–≥—Ä–∞–¥–∞", "–ú–æ–Ω–æ–ª–æ–≥ –°–µ—Ä–≥–µ—è –õ–µ–π–±–≥—Ä–∞–¥–∞", "–ü–æ–±–µ–¥–∏—Ç–µ–ª—å –∏ –±–æ–Ω—É—Å-–ø—Ä–æ—Å–º–æ—Ç—Ä", "–ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏, –ø—Ä–æ—â–∞–Ω–∏–µ", "–ü—Ä–æ—â–∞–Ω–∏–µ, –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏", "–ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–æ—â–∞–Ω–∏–µ", "–ü—Ä–æ—â–∞–Ω–∏–µ –∏ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏", "–°–µ—Ä–∏–∞–ª ¬´–®–µ—Å—Ç–æ–π –∫–∞—Å—Å–∞—Ü–∏–æ–Ω–Ω—ã–π¬ª: ", "–°–∞–≥–∞ –æ –∂–∞–±–æ–≥–∞–¥—é–∫–∏–Ω–≥–µ: ", "–ñ–∏–≤–æ–π —É–≥–æ–ª–æ–∫ –°–∞–º–∞—Ä—ã: ", "–°–∞–º–∞—Ä—Å–∫–∏–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç", "–ê–Ω–æ–Ω—Å –†–ó–ì–í–†", "–ê–Ω–æ–Ω—Å ¬´–í—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–Ω–∞–Ω–∏—è¬ª", "–ü—Ä–æ—â–∞–Ω–∏–µ –∏ –∞–Ω–æ–Ω—Å –†–ó–ì–í–†", "–ü—Ä–æ—â–∞–Ω–∏–µ –∏ –∞–Ω–æ–Ω—Å ¬´–í—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–Ω–∞–Ω–∏—è¬ª", "–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ"];
		    suggestions.sort();
		    const suggestionsList = document.createElement('ul');
		    suggestionsList.id = "popups";
		    suggestionsList.style.display = 'none';
		    container.appendChild(suggestionsList);

		    newTextarea.addEventListener('input', function(e) {
			    const inputText = this.value.toLowerCase();
			    suggestionsList.innerHTML = '';
			    if (!suggestions.filter(suggestion => suggestion.toLowerCase().startsWith(inputText)).length) {
					suggestionsList.style.display = 'none';
				}
			    else {
			    	suggestionsList.style.display = 'block';
			    	var rect = e.currentTarget.getBoundingClientRect();
			    	//console.log(rect.top + document.body.scrollTop);
			    	suggestionsList.style.top = rect.top + window.scrollY + 15 + "px";
			    	suggestionsList.style.left = rect.left + window.scrollX + "px";
			    }
			    suggestions.filter(suggestion => suggestion.toLowerCase().startsWith(inputText)).forEach(suggestion => {
			        const li = document.createElement('li');
			        li.innerText = suggestion + " ";

			        li.addEventListener('click', function() {
			          	newTextarea.value = this.innerText + " ";
			          	newTextarea.focus();
			          	suggestionsList.style.display = 'none';
			          	autoGrowTextarea(newTextarea);
		    			saveForm(new Event("click"));
			        });
			        suggestionsList.appendChild(li);
					document.addEventListener('click', (e) => {
					  if (!newTextarea.contains(e.target)) {
					    suggestionsList.style.display = 'none';
					  }
					});
			    });
		    });
		    container.appendChild(suggestionsList);
        calculateSigns();
		  };
		function autoGrowTextarea(textarea) {
		    textarea.style.height = "5px";
		    textarea.style.height = (textarea.scrollHeight) + "px";
		  }
		function deleteRow(e){
			var confirmation = confirm("–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å, –¥–∞? ü§î");
	    	if (confirmation) {
	        e.currentTarget.parentElement.parentElement.remove();
          calculateSigns();
		  }
      
		};

		function toggleEdit() {
        const titleElement = document.getElementById('editableTitle');
        const titleText = titleElement.firstChild.nodeValue.trim();

        // Create an input element
        const inputElement = document.createElement('input');
        inputElement.type = 'text';
        inputElement.value = titleText;
        inputElement.id = 'inputNewTitle';

        // Replace the h3 content with the input element
        titleElement.innerHTML = '';
        titleElement.appendChild(inputElement);

        // Focus on the input field
        inputElement.focus();

        // Add an event listener to capture the changes when focus is lost

        inputElement.addEventListener('blur', function () {
            // Get the new value
            let newValue = inputElement.value;
            titleElement.innerHTML = newValue + ' <button id="edit" onclick="toggleEdit()"><img src="{% static 'edit.png' %}" width="20px" height="20px"></button>';

            // Update the title asynchronously using Fetch API
            let form = document.querySelector('form');
				    document.querySelector("#editableTitle").value = newValue;
				    let formData = new FormData(form);
				    console.log('Before setting title:', formData.get('title'));
						formData.set('title', newValue);
						console.log('After setting title:', formData.get('title'));

            fetch(form.action, {
                method: form.method,
                body: formData
            })
                .then(function (response) {
                    if (response.ok) {
                        // Replace the input element with a new h3 element
                        //titleElement.innerHTML = newValue + ' <button id="edit" onclick="toggleEdit()">Edit</button>';
                        console.log('Title updated successfully');
                    } else {
                        console.log('Title update failed');
                    }
                })
                .catch(function (error) {
                    console.error('Error updating title:', error);
                });
        });
        saveForm(new Event("click"));
    }

		function addNewRow() {
		    const row = document.createElement("tr");
		    row.innerHTML = `
		      <td>
		        <input type="tel" id="timecode${rowNum}" name="timecode${rowNum}" maxlength="8" class="tc">
		      </td>
		      <td>
		        <textarea id="text${rowNum}" name="text${rowNum}" rows="1" oninput="autoGrowTextarea(this)" maxlength="200"></textarea>
		      </td>
		      <td><button class = "delete"><img src="{% static 'delete.png' %}" width="50px" height="50px"></button>
		      	  <button id="pauseButton"><img src="{% static 'addcode.png' %}" width="50px" height="50px"></button>
		          <button class="drag"><img src="{% static 'drag.png' %}" width="30px" height="30px"></button>
		      </td>
		    `;
		    //setupDragEvents(row);
		    const newRowInput = row.querySelector("input");
		    const newTextarea = row.querySelector("textarea");
		    setTimeout(() => {
			  newTextarea.focus();
			}, 0);
		    row.querySelector(".delete").addEventListener("click", deleteRow);
		    row.querySelector(".delete").addEventListener("click", saveForm);
		    
        row.querySelectorAll("#pauseButton").forEach(button => {
          button.addEventListener("click", e => {
          var tr = e.currentTarget.parentElement.parentElement;
          var input = tr.querySelector("input");
          if (input) {
            var player = onYouTubeIframeAPIReady();
            var newCurrentTime = formatTime(player.getCurrentTime());

            // Check if the input value is not empty
            if (input.value.trim() !== '') {
              // Parse the input value to a float
              var savedTime = parseFloat(input.value);

              // Update the input value with the new current time
              input.value = newCurrentTime;

            } else {
              // If the input is empty, just set the input value to the new current time
              input.value = newCurrentTime;
            }
          }
          saveForm(e);
        });
      });
		    newRowInput.addEventListener("keydown", e => {
		    	if(e.currentTarget.value.length == 8 || e.key === "Enter" || e.key === "Tab") {
			  		e.currentTarget.value += "";
			    	// setTimeout(() => {
				  	// 	newTextarea.focus();
					// }, 0);
					return true;
		    	}
			    if (!(e.keyCode >= 48 && e.keyCode <= 57 || e.keyCode >= 96 && e.keyCode <= 105 || e.keyCode === 8)){
			    	e.preventDefault();
			    }
		    	const regex = /^[0-9:]+$/; // —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ
		  		if(!regex.test(e.currentTarget.value)){ // –µ—Å–ª–∏ —Å–∏–º–≤–æ–ª—ã –Ω–µ —è–≤–ª—è—é—Ç—Å—è —Ü–∏—Ñ—Ä–∞–º–∏ –∏–ª–∏ –¥–≤–æ–µ—Ç–æ—á–µ–º
				    e.currentTarget.value = e.currentTarget.value.slice(0, -1); // —É–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–∏–º–≤–æ–ª –∏–∑ –∑–Ω–∞—á–µ–Ω–∏—è input
				    return false; // –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏, —á—Ç–æ–±—ã –≤–≤–µ–¥–µ–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω–µ
		  		}
				// –¥–æ–±–∞–≤–ª—è–µ–º –¥–≤–æ–µ—Ç–æ—á–∏–µ –∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ü–∏—Ñ—Ä
				if ((e.currentTarget.value.length === 2 || e.currentTarget.value.length === 5) && e.keyCode !== 8) {
				    e.currentTarget.value += ":";
		  		} else if (e.currentTarget.value.length > 8) {
		    		e.currentTarget.value = e.currentTarget.value.slice(0, 8);
		  		} else if ((e.currentTarget.value.length === 3 || e.currentTarget.value.length === 6) && e.keyCode === 8){
		    		const inputValueArray = e.currentTarget.value.split('');
		    		inputValueArray.splice(-1, 1);
		    		e.currentTarget.value = inputValueArray.join('');
		  		}
		  		return true; // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º true, —á—Ç–æ–±—ã –≤–≤–µ–¥–µ–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª –æ—Ç–æ–±—Ä–∞–∑–∏–ª—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω–µ
			}); 
		    addSuggestions(newTextarea);
		    container.appendChild(row);

		    newTextarea.addEventListener("input", function() {
		      let value = this.value;
		      if (value.length > 0) {
		        this.value = value.charAt(0).toUpperCase() + value.slice(1);
		      }
		    });
		    row.addEventListener("change", saveForm);
		    //row.addEventListener("DOMContentLoaded", qwerty);
		    qwerty();
		    //newRowInput.addEventListener("change", saveForm);
		    //newTextarea.addEventListener("change", saveForm);
        calculateSigns();
		    }
		rowNum++;
    function calculateSigns(){
      let timestamps = [];
      let texts = [];

      document.querySelectorAll("tr").forEach(tr => {
            let timestampInput = tr.querySelector("input");
            let textAreaInput = tr.querySelector("textarea");

            let timestamp = timestampInput.value;
            let text = textAreaInput.value;

            timestamps.push(timestamp);
            texts.push(text);
            timestampInput.addEventListener("input", calculateSigns);
            textAreaInput.addEventListener("input", calculateSigns);
        });
      const totalTimestampCharacterCount = timestamps.join('').length;
      const totalTextCharacterCount = texts.join(' ').length;
      const totalCharacterCount = totalTimestampCharacterCount + totalTextCharacterCount + 1;
      //console.log(`Total character count: ${totalCharacterCount}`);
      const characterCountDisplay = document.getElementById("characterCountDisplay");
      characterCountDisplay.textContent = `–í–∞—à–∏ –ª–∞–ø–∫–∏ –Ω–∞–ø–µ—á–∞—Ç–∞–ª–∏ –∑–Ω–∞–∫–æ–≤: ${totalCharacterCount}`;
      if (totalCharacterCount > 3100) {
        characterCountDisplay.classList.add("over-limit");
      } else {
        characterCountDisplay.classList.remove("over-limit");
      }
    }  
		function saveForm(event) {
				  event.preventDefault(); // Prevent page reload
				  
				  let form = document.querySelector('form');
				  
				  let timestamps = [];
			 	  let texts = [];

			 	  document.querySelectorAll("tr").forEach(tr => {
				        let timestampInput = tr.querySelector("input");
				        let textAreaInput = tr.querySelector("textarea");
				        
				        let timestamp = timestampInput.value;
				        let text = textAreaInput.value;
				        
				        timestamps.push(timestamp);
				        texts.push(text);
				    });
				    document.querySelector("#timestamps-field").value = timestamps.join("\n");
				    document.querySelector("#texts-field").value = texts.join("\n");

            

				    let formData = new FormData(form);
					  formData.set('timestamps_field', timestamps.join("\n"));
					  formData.set('texts_field', texts.join("\n"));

				  fetch(form.action, {
				    method: form.method,
				    body: formData
				  })
				  .then(response => {
				    if (response.ok) {
				      // Handle successful response
				      console.log("Form submitted successfully!");
				      // You can perform any additional actions here, such as updating the UI or displaying a success message
				    } else {
				      // Handle error response
				      console.error("Form submission failed!");
				    }
				  })
				  .catch(error => {
				    // Handle network or other errors
				    console.error("An error occurred while submitting the form:", error);
				  });

				  document.querySelectorAll(".tc").forEach(i => {
				  	if (i.value.split(":")[0] == "00" && i.value.split(":").length == 3) {
					  	i.value = i.value.slice(3);
					  }
				  });
        calculateSigns();
				}
		function incrementTime(isAddition = true) {
			  console.log("rabotaet");
			  // Get the increment value entered by the user
			  const incrementValue = document.getElementById("timeInput").value;

			  // Get all the input elements containing time values
			  var timeInputs = [...document.querySelectorAll(".tc")].slice(1);
			  var iVal = incrementValue.split(":");

			  // Iterate over each input element and increment the time value
			  for (var i = 0; i < timeInputs.length; i++) {
			  	  var tInputs = timeInputs[i].value.split(":");
			  	  
				  var seconds = "";
				  var minutes = "";
				  var hours = "";
				  var result = "";
				  var resNum = 0;
				  if (tInputs.length === 3) {
				  	result = "";
				  	seconds = tInputs[2];
				  	minutes = tInputs[1];
				  	hours = tInputs[0];
				  	if(isAddition)
					  	resNum = (parseInt(seconds) + parseInt(minutes)*60 + parseInt(hours)*3600)+(parseInt(iVal[2]) + parseInt(iVal[1])*60 + parseInt(iVal[0])*3600);
					else resNum = (parseInt(seconds) + parseInt(minutes)*60 + parseInt(hours)*3600)-(parseInt(iVal[2]) + parseInt(iVal[1])*60 + parseInt(iVal[0])*3600);
				  	result += "" + (Math.floor(resNum / 3600) > 9 ? Math.floor(resNum / 3600) : ("0"+Math.floor(resNum / 3600))) + ":" + 
				  				   (Math.floor((resNum % 3600) / 60) > 9 ? Math.floor((resNum % 3600) / 60) : ("0"+Math.floor((resNum % 3600) / 60))) + ":" + 
				  				   (((resNum % 3600) % 60) > 9 ? ((resNum % 3600) % 60) : ("0"+((resNum % 3600) % 60)));
				  	console.log(result);
				  }
				  if (tInputs.length === 2) {
				  	result = "";
				  	seconds = tInputs[1];
				  	minutes = tInputs[0];
				  	if(isAddition) resNum = (parseInt(seconds) + parseInt(minutes)*60) +(parseInt(iVal[2]) + parseInt(iVal[1])*60);
				  	else resNum = (parseInt(seconds) + parseInt(minutes)*60)-(parseInt(iVal[2]) + parseInt(iVal[1])*60);
				  	if (resNum < 0) {
				  		result = "00:00";
				  	}
				  	else{
				  		result += "" + (Math.floor(resNum / 3600) > 9 ? Math.floor(resNum / 3600) : ("0"+Math.floor(resNum / 3600))) + ":" + 
				  				   (Math.floor((resNum % 3600) / 60) > 9 ? Math.floor((resNum % 3600) / 60) : ("0"+Math.floor((resNum % 3600) / 60))) + ":" + 
				  				   (((resNum % 3600) % 60) > 9 ? ((resNum % 3600) % 60) : ("0"+((resNum % 3600) % 60)));
				  	}
				  	
				  	console.log(result);
				  }
				  timeInputs[i].value = result;
			  }
			  saveForm(new Event("click"));
		}
		function formatTime(totalSeconds) {
		  const hours = Math.floor(totalSeconds / 3600);
		  const minutes = Math.floor((totalSeconds % 3600) / 60);
		  const seconds = Math.floor(totalSeconds % 60);

		  let formattedTime = "";
		  if (hours > 0) {
		    formattedTime += padZero(hours) + ":";
		  }
		  formattedTime += padZero(minutes) + ":" + padZero(seconds);
		  return formattedTime;
		}
		function padZero(number) {
		  return number.toString().padStart(2, "0");
		}
		function qwerty() {
		  const container = document.getElementById("fields");
		  const dragButtons = document.querySelectorAll(".drag");
		  let isDragging = false;
		  let saveTimeout; // Variable to store the saveForm timeout

		  // Initialize dragula with the container
		  const drake = dragula([container], {
		    copy: false, // Disable cloning of dragged elements
		  });

		  // Create autoScroll instance
		  const scroll = autoScroll([
		    window,
		    container
		  ], {
		    margin: 20,
		    autoScroll: function() {
		      return this.down && drake.dragging;
		    }
		  });

		  // Handle drag event
		  drake.on("drag", function(el) {
		    if (isDragging) {
		      // Add the dragging class
		      el.classList.add("dragging");
		    } else {
		      // Cancel the drag operation
		      drake.cancel();
		    }
		  });

		  // Handle dragend event
		  drake.on("dragend", function(el) {
		    // Remove the dragging class
		    el.classList.remove("dragging");

		    // If dragging occurred, save the form after a delay
		    if (isDragging) {
		      clearTimeout(saveTimeout);
		      saveTimeout = setTimeout(function() {
		        saveForm(new Event("click"));
		      }, 100); // Adjust the delay as needed
		    }

		    // Set the isDragging flag to false
		    isDragging = false;
		  });

		  // Add event listeners to the drag buttons
		  dragButtons.forEach((button) => {
		    // Handle mousedown event on drag button
		    button.addEventListener("mousedown", function() {
		      // Set the isDragging flag to true
		      isDragging = true;
		    });

		    // Handle mouseup event on drag button
		    button.addEventListener("mouseup", function() {
		      // Set the isDragging flag to false
		      isDragging = false;

		      // Save the form after mouseup
		      saveForm(new Event("click"));
		    });

		    // Handle touchstart event on drag button
		    button.addEventListener("touchstart", function(event) {
		      // Prevent default touch behavior and set the isDragging flag to true
		      event.preventDefault();
		      isDragging = true;
		    });

		    // Handle touchend event on drag button
		    button.addEventListener("touchend", function() {
		      // Set the isDragging flag to false
		      isDragging = false;

		      // Save the form after touchend with a delay
		      clearTimeout(saveTimeout);
		      saveTimeout = setTimeout(function() {
		        saveForm(new Event("click"));
		      }, 100); // Adjust the delay as needed
		    });
		  });

		  // Prevent touchmove event default behavior when dragging
		  document.addEventListener("touchmove", function(event) {
		    if (isDragging) {
		      event.preventDefault();
		    }
		  }, { passive: false });
		}

		function onYouTubeIframeAPIReady() {
		    if (!player) {
		    	player = new YT.Player('player', {
					height: "250vh",
					width: "100%",
		        videoId: '{{link}}',
		        playerVars: {
		            'playsinline': 1,
		            'fs': 0,
		            'iv_load_policy': 3
		        },
		        events: {
		            'onReady': onPlayerReady,
		            'onStateChange': onPlayerStateChange
		        }
		    });
		    }
		    return player;
		}
		function onPlayerReady(event) {
		    event.target.playVideo();
		}
		function onPlayerStateChange(event) {
		    // Handle player state change events
		    // For example, you can perform actions based on the player's state
		    if (event.data === YT.PlayerState.PLAYING) {
		        console.log('Player is playing');
		    } else if (event.data === YT.PlayerState.PAUSED) {

		    } else if (event.data === YT.PlayerState.ENDED) {
		        console.log('Player has ended');
		    };
		};


		function showInputField() {
	    // Show the input field container
	    document.getElementById('inputFieldContainer').style.display = 'block';
	  }

		function updatePlayer() {
		  var youtubeLink = document.getElementById('videoInput').value;
		  var videoId = extractVideoId(youtubeLink);

		  if (player) {
		    // Update the videoId and load the new video
		    player.loadVideoById(videoId);

		    // Send the new video ID to the server
		    let form = document.querySelector('form');
		    document.querySelector("#video-Id").value = videoId;
		    let formData = new FormData(form);
		    formData.set('video_Id', videoId);


		    fetch(form.action, {
		      method: form.method,
		      body: formData
		    })
		      .then(function(response) {
		        if (response.ok) {
		          console.log('Video ID updated successfully');
		        } else {
		          console.log('Video ID update failed');
		        }
		      })
		      .catch(function(error) {
		        console.error('Error updating video ID:', error);
		      });
		  }
		  saveForm(new Event("click"));
		}


	  // Helper function to extract the videoId from YouTube link
		function extractVideoId(link) {
		  // Check if the link is in the format: https://www.youtube.com/watch?v=VIDEO_ID
		  var match = link.match(/youtube\.com\/watch\?v=([^&]+)/);
		  if (match) {
		    return match[1];
		  }

		  // Check if the link is in the format: https://youtu.be/VIDEO_ID
		  match = link.match(/youtu\.be\/([^?]+)/);
		  if (match) {
		    return match[1];
		  }

		  // Check if the link is in the format: https://www.youtube.com/live/VIDEO_ID
		  match = link.match(/youtube\.com\/live\/([^?]+)/);
		  if (match) {
		    return match[1];
		  }

		  // If no match is found, return null or handle the error as needed
		  return null;
		}

		</script>




  
	{% else %}
		<script>
				const container = document.getElementById("fields");
				const addRowButton = document.getElementById("addRow");
				const textarea = document.getElementById("text0");
				let rowNum = 1; // –Ω–æ–º–µ—Ä –ø–µ—Ä–≤–æ–π –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏
				var player = null;
				var playerElement = document.querySelector('#player');
				var wrapper = document.querySelector('#wrapper');
				playerElement.style.display = "none";
				resize.style.display = "none";
				resizeHeight.style.display = "none";
				move.style.display = "none";
				changeLink.style.display = "none";

				document.querySelector("#video").addEventListener("click", e => {
				    if (document.querySelector('#player').style.display === "none") {
				        // Load the YouTube IFrame API script if it hasn't been loaded already
				        if (!window.YT) {
				            var tag = document.createElement('script');
				            tag.src = "https://www.youtube.com/iframe_api";
				            var firstScriptTag = document.getElementsByTagName('script')[0];
				            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
				        } else {
				            // If the API script is already loaded, create the player immediately
				            onYouTubeIframeAPIReady();
				        }
				        // Show the player
				        
				        document.querySelector('#player').style.display = "flex";
				        wrapper.style.display = "flex";
				        changeLink.style.display = "block";	   
				        resize.style.display = "none";
				        resizeHeight.style.display = "none";
				        move.style.display = "none";     
				    } else {
			        player.stopVideo();
			    		document.querySelector('#player').style.display = "none"; 
			    		wrapper.style.display = "none";
			    		changeLink.style.display = "none";  
			    		resize.style.display = "none";
			    		resizeHeight.style.display = "none";
			        move.style.display = "none";		
			    	} 
				});

				document.querySelector("#changeLink").addEventListener("click", e => {
					  const videoInput = document.querySelector("#videoInput");
					  const updateButton = document.querySelector("#updateButton");

					  if (videoInput.style.display === "none") {
					  	inputFieldContainer.style.display = "flex";
					    videoInput.style.display = "initial";
					    updateButton.style.display = "initial";
					  } else {
					    videoInput.style.display = "none";
					    updateButton.style.display = "none";
					  }
				}); 

				document.addEventListener("DOMContentLoaded", function() {
				  interact('#wrapper')
				    .draggable({
				      inertia: true,
				      modifiers: [
				        interact.modifiers.restrictRect({
				          restriction: 'window',
				          endOnly: true
				        })
				      ],
				      listeners: {
				        start(event) {
				          $('.frameOverlay').show();
				          disableScroll(); // Disable page scrolling
				        },
				        move(event) {
				          const target = event.target;
						  const rect = target.getBoundingClientRect();
						  const targetWidth = rect.width;
						  const targetHeight = rect.height;
						  const minX = 0;
						  const maxX = window.innerWidth - targetWidth;
						  const maxY = window.innerHeight - targetHeight;

						  const x = parseFloat(target.getAttribute('data-x')) || 0; // Use current x position
						  const y = Math.max(Math.min(maxY, (parseFloat(target.getAttribute('data-y')) || 0) + event.dy));

						  target.style.transform = `translate(${x}px, ${y}px)`;
						  target.setAttribute('data-x', x);
						  target.setAttribute('data-y', y);
				        },
				        end(event) {
				          $('.frameOverlay').hide();
				          enableScroll(); // Enable page scrolling
				        }
				      }
				    })
				    // .resizable({
				    //   edges: { left: true, right: true, bottom: true, top: true },
				    //   listeners: {
				    //     start(event) {
				    //       $('.frameOverlay').show();
				    //       disableScroll(); // Disable page scrolling
				    //     },
				    //     move(event) {
				    //       const target = event.target;
				    //       const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.deltaRect.left;
				    //       const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.deltaRect.top;

				    //       target.style.width = event.rect.width + 'px';
				    //       target.style.height = event.rect.height + 'px';
				    //       target.style.transform = 'translate(' + x + 'px,' + y + 'px)';

				    //       target.setAttribute('data-x', x);
				    //       target.setAttribute('data-y', y);
				    //     },
				    //     end(event) {
				    //       $('.frameOverlay').hide();
				    //       enableScroll(); // Enable page scrolling
				    //     }
				    //   }
				    // })
				    // .styleCursor({
				    //   left: 'w-resize',
				    //   right: 'e-resize',
				    //   top: 'n-resize',
				    //   bottom: 's-resize',
				    //   topLeft: 'nw-resize',
				    //   topRight: 'ne-resize',
				    //   bottomLeft: 'sw-resize',
				    //   bottomRight: 'se-resize'
				    // });

				  function disableScroll() {
				    document.addEventListener('touchmove', preventScroll, { passive: false });
				  }

				  function enableScroll() {
				    document.removeEventListener('touchmove', preventScroll);
				  }

				  function preventScroll(event) {
				    event.preventDefault();
				  }
				});

				document.querySelectorAll("#pauseButton").forEach(button => {
			    button.addEventListener("click", e => {
			      var tr = e.currentTarget.parentElement.parentElement;
			      var input = tr.querySelector("input");
			      if (input && input.value.trim().length == 0) {
			        input.value = formatTime(onYouTubeIframeAPIReady().getCurrentTime());
			      }
			      saveForm(new Event("click"));
			    });
			  });

				document.addEventListener('DOMContentLoaded', function() {
				  var wrapperElement = document.querySelector('#wrapper');

				  stickybits(wrapperElement, {
				    stickyBitStickyOffset: 0, // Set the offset to 0
				    verticalPosition: 'bottom', // Stick element to the bottom
				    useGetBoundingClientRect: true,
				  });
				});
				document.querySelectorAll(".tc").forEach(i => {
							  	if (i.value.split(":")[0] == "00" && i.value.split(":").length == 3) {
								  	i.value = i.value.slice(3);
								  }
							  });
				addRowButton.addEventListener("click", function() {
				    	addNewRow();
				  });
				document.querySelector('#changeTime').addEventListener("click", e => {
					document.querySelector("#timeForm").classList.toggle("hidden");
					if (!document.querySelector("#timeForm").classList.contains("hidden"))
					{
						document.querySelector("#timeForm").style.display = "flex";
					}
					else {
						document.querySelector("#timeForm").style.display = "none";
					}
				});

				document.querySelector("#save").addEventListener("click", e => {
				  		document.querySelector(".pics").classList.toggle("hidden");
				  		saveForm(e);
				  });
			  document.querySelector("#lesina").addEventListener("click", e => {
						document.querySelector(".pic").classList.toggle("hidden");
				  });
				document.querySelectorAll("input")[document.querySelectorAll("textarea").length-1].focus();
				document.querySelectorAll("textarea").forEach(i => {
				  		i.style.height = "5px";
				    	i.style.height = (i.scrollHeight) + "px";
				  });
				document.querySelectorAll(".delete").forEach(i => {
				  		i.addEventListener("click", deleteRow)
				  		i.addEventListener("click", saveForm)
				  });
				for (var i = 1; i < document.querySelectorAll("textarea").length; i++) {
				  		addSuggestions(document.querySelectorAll("textarea")[i]);
				  		autoGrowTextarea(document.querySelectorAll("textarea")[i]);
				  }
				document.querySelectorAll("input").forEach(i => {
				    	//i.addEventListener("change", saveForm);
				    	i.addEventListener("keydown", e => {
				    		if(e.currentTarget.value.length == 8 || e.key === "Enter" || e.key === "Tab") {
						  		e.currentTarget.value += "";
						    	// setTimeout(() => {
							  	// 	i.parentElement.parentElement.querySelector("textarea").focus();
								// }, 0);
								return true;
					    	}
					  		if (!(e.keyCode >= 48 && e.keyCode <= 57 || e.keyCode >= 96 && e.keyCode <= 105 || e.keyCode === 8)){
						    	e.preventDefault();
						    }
					    	const regex = /^[0-9:]+$/; // —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ
					  		if(!regex.test(e.currentTarget.value)){ // –µ—Å–ª–∏ —Å–∏–º–≤–æ–ª—ã –Ω–µ —è–≤–ª—è—é—Ç—Å—è —Ü–∏—Ñ—Ä–∞–º–∏ –∏–ª–∏ –¥–≤–æ–µ—Ç–æ—á–µ–º
							    e.currentTarget.value = e.currentTarget.value.slice(0, -1); // —É–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–∏–º–≤–æ–ª –∏–∑ –∑–Ω–∞—á–µ–Ω–∏—è input
							    return false; // –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏, —á—Ç–æ–±—ã –≤–≤–µ–¥–µ–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω–µ
					  		}
							// –¥–æ–±–∞–≤–ª—è–µ–º –¥–≤–æ–µ—Ç–æ—á–∏–µ –∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ü–∏—Ñ—Ä
							if ((e.currentTarget.value.length === 2 || e.currentTarget.value.length === 5) && e.keyCode !== 8) {
							    e.currentTarget.value += ":";
					  		} else if (e.currentTarget.value.length > 8) {
					    		e.currentTarget.value = e.currentTarget.value.slice(0, 8);
					  		} else if ((e.currentTarget.value.length === 3 || e.currentTarget.value.length === 6) && e.keyCode === 8){
					    		const inputValueArray = e.currentTarget.value.split('');
					    		inputValueArray.splice(-1, 1);
					    		e.currentTarget.value = inputValueArray.join('');
					  		}
					  		return true; // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º true, —á—Ç–æ–±—ã –≤–≤–µ–¥–µ–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª –æ—Ç–æ–±—Ä–∞–∑–∏–ª—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω–µ
						});
			    });
				document.querySelector("#copy").addEventListener("click", e => {
					    let text = "";
					    document.querySelectorAll("tr").forEach(tr => {
					        text += tr.querySelector("input").value + " " + tr.querySelector("textarea").value + "\n";
					    });

				        // Use Clipboard API if available
				        navigator.clipboard.writeText(text)
				            .then(() => {
				                alert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!");
				            })
				            .catch((error) => {
				                // Fallback for unsupported browsers (e.g., mobile browsers)
						        const input = document.createElement("textarea");
						        input.value = text;
						        document.body.appendChild(input);
						        input.select();

						        try {
						            // Execute copy command
						            document.execCommand("copy");
						            alert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!");
						        } catch (err) {
						            alert("–ù–ï –°–ö–û–ü–ò–†–û–í–ê–ù–û!" + " " + "err");
						        }

				        document.body.removeChild(input);
				            });
					});

				document.querySelectorAll("tr").forEach(i => {
				  			i.addEventListener("change", saveForm);
				  			});
				document.querySelectorAll("tr")[0].querySelector(".delete").style.display = "none";
				document.querySelectorAll("tr")[0].querySelector(".drag").style.display = "none";
				document.querySelectorAll("tr")[0].querySelector("#pauseButton").style.display = "none";

				document.addEventListener("DOMContentLoaded", qwerty);
				//qwerty();

				addFirstSuggestions(textarea);
				
				function addFirstSuggestions(textarea) {
				  	const suggestions = ['–ó–∞—Å—Ç–∞–≤–∫–∞', '–ú—É–∑—ã–∫–∞', '–ó–∞—Å—Ç–∞–≤–∫–∞, –º—É–∑—ã–∫–∞', '–ú—É–∑—ã–∫–∞, –∑–∞—Å—Ç–∞–≤–∫–∞', "–ó–∞—Å—Ç–∞–≤–∫–∞ –∏ –º—É–∑—ã–∫–∞", "–ú—É–∑—ã–∫–∞ –∏ –∑–∞—Å—Ç–∞–≤–∫–∞", "–ó–∞—Å—Ç–∞–≤–∫–∞ —Å –º—É–∑—ã–∫–æ–π", "–ú—É–∑—ã–∫–∞ —Å –∑–∞—Å—Ç–∞–≤–∫–æ–π"];
				    suggestions.sort();
				    const suggestionsList = document.createElement('ul');
				    suggestionsList.id = "popups";
				    suggestionsList.style.display = 'none';
				    container.appendChild(suggestionsList);

				    textarea.addEventListener('input', function() {
				      const inputText = this.value.toLowerCase();
				      suggestionsList.innerHTML = '';
				      if (!suggestions.filter(suggestion => suggestion.toLowerCase().startsWith(inputText)).length) {
							suggestionsList.style.display = 'none';
						}
					    else {
					    	suggestionsList.style.display = 'block';
					    	var rect = textarea.getBoundingClientRect();
					    	//console.log(rect.top + document.body.scrollTop);
					    	suggestionsList.style.top = rect.top + document.body.scrollTop + "px";
					    	suggestionsList.style.left = rect.left + document.body.scrollLeft + "px";
					    }
				      suggestions.filter(suggestion => suggestion.toLowerCase().startsWith(inputText)).forEach(suggestion => {
				        const li = document.createElement('li');
				        li.innerText = suggestion;

				        li.addEventListener('click', function() {
				          textarea.value = this.innerText;
				          suggestionsList.style.display = 'none';
				          textarea.focus();
				          autoGrowTextarea(textarea);
				   		  saveForm(new Event("click"));
				        });
				        suggestionsList.appendChild(li);
				        document.addEventListener('click', (e) => {
							if (!textarea.contains(e.target)) {
							    suggestionsList.style.display = 'none';
							  	}
							});
				        if (!suggestion.toLowerCase().startsWith(inputText)) suggestionsList.style.display = 'none';
					    else {
					    	suggestionsList.style.display = 'block';
					    	var rect = textarea.getBoundingClientRect();
					    	console.log(rect.top + document.body.scrollTop);
					    	suggestionsList.style.top = rect.top + document.body.scrollTop + "px";
					    	suggestionsList.style.left = rect.left + document.body.scrollLeft + "px";
					    }
				      });
				    });
				    container.appendChild(suggestionsList);
				    //autoGrowTextarea(textarea);
				  };
				function addSuggestions(newTextarea) {
				    const suggestions = ['–ò—Ç–æ–≥–∏ –æ–ø—Ä–æ—Å–∞ –ø—Ä–æ ', '–ò—Ç–æ–≥–∏ –æ–ø—Ä–æ—Å–∞ –æ', '–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞ –Ω–æ–≤—ã–π —Ñ–∏–ª—å–º', '–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞ –∫—Ä–∏–Ω–∂', '–ü–æ–±–µ–¥–∏—Ç–µ–ª—å', '–•–∏–Ω—à—Ç–µ–π–Ω vs. –ï—Ñ–∞–Ω–æ–≤:', '–•–∏–Ω—à—Ç–µ–π–Ω –ø—Ä–æ—Ç–∏–≤ –ï—Ñ–∞–Ω–æ–≤–∞:', '¬´–ß—Ç–æ –∫—É–ø–∏—Ç—å –≤ –°–∞–º–∞—Ä–µ?¬ª: ', '–ß—Ç–æ –∫—É–ø–∏—Ç—å –≤ –°–∞–º–∞—Ä–µ?: ', '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –†–ó–í–†–¢: ', '–ù–æ–≤–æ—Å—Ç–∏ –†–æ—Å—Å–∏–∏ ', '–ù–æ–≤–æ—Å—Ç–∏ –°–∞–º–∞—Ä—ã ', "–ù–æ–≤–æ—Å—Ç–∏ –£–∫—Ä–∞–∏–Ω—ã ", "–ù–æ–≤–æ—Å—Ç–∏ –º–∏—Ä–∞ ", "–ù–æ–≤–æ—Å—Ç—å –û–º—Å–∫–∞", "–ù–æ–≤–æ—Å—Ç—å –∏–∑ –û–º—Å–∫–∞", "–û–¥–Ω–∞ –Ω–æ–≤–æ—Å—Ç—å –∏–∑ –û–º—Å–∫–∞", '–ù–∞—á–∞–ª–æ', "–ü—Ä–æ—â–∞–Ω–∏–µ –∏ ", "–ü—Ä–æ—â–∞–Ω–∏–µ –∏ –ø–µ—Å–Ω—è", "–ü–µ—Å–Ω—è", "–ü—Ä–æ—â–∞–Ω–∏–µ", "–ß–∞—Ç: ", "–î–æ–Ω–∞—Ç—ã", "–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞–Ω–∞–ª–∞", "–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞–Ω–∞–ª–∞, –¥–æ–Ω–∞—Ç—ã", "–£–≥–æ–ª–æ–∫ –ø—Ä–æ–ø–∞–≥–∞–Ω–¥–∏—Å—Ç–∞: ", "–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –†–ó–í–†–¢: –ò–≥–æ—Ä—å –°–∞–∂–∏–Ω –æ", "–ß–∞—Ç: –ø—Ä–æ ", "–ï—â–µ –ø—Ä–æ ", "–ï—â—ë –ø—Ä–æ", "–ü–æ–¥–≤–æ–¥–∫–∞ –∫ —Ä–∞–∑–≥–æ–≤–æ—Ä—É —Å ", "–†–∞–∑–≥–æ–≤–æ—Ä —Å", "–ù–æ–≤–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –∑–∞—Å–ª—É–∂–∏–ª–∏", "–ü–ª–∞–Ω —ç—Ñ–∏—Ä–∞", "–ù–∞—á–∞–ª–æ, –ø–ª–∞–Ω —ç—Ñ–∏—Ä–∞", "–ù–∞—á–∞–ª–æ, –ø–ª–∞–Ω —ç—Ñ–∏—Ä–∞, –≥–µ–æ–ø–µ—Ä–µ–∫–ª–∏—á–∫–∞", "–ì–µ–æ–ø–µ—Ä–µ–∫–ª–∏—á–∫–∞", "–£—Ä–æ–∫ –≥–µ–æ–≥—Ä–∞—Ñ–∏–∏", "–ì–µ–æ–≥—Ä–∞—Ñ–∏—è —Å–ª—É—à–∞—Ç–µ–ª–µ–π", "–ì–µ–æ–≥—Ä–∞—Ñ–∏—è –†–ó–í–†–¢", '–ù–æ–≤–æ—Å—Ç–∏ –†–æ—Å—Å–∏–∏: ', '–ù–æ–≤–æ—Å—Ç–∏ –°–∞–º–∞—Ä—ã: ', "–ù–æ–≤–æ—Å—Ç–∏ –£–∫—Ä–∞–∏–Ω—ã: ", "–ù–æ–≤–æ—Å—Ç–∏ –º–∏—Ä–∞: ", "–ü—Ä–æ—â–∞–Ω–∏–µ –∏ –ß–µ—Ä–≤–æ–Ω–∞ –∫–∞–ª–∏–Ω–∞", "–ü—Ä–æ—â–∞–Ω–∏–µ –∏ ¬´–ß–µ—Ä–≤–æ–Ω–∞ –∫–∞–ª–∏–Ω–∞¬ª"];
				    suggestions.sort();
				    const suggestionsList = document.createElement('ul');
				    suggestionsList.id = "popups";
				    suggestionsList.style.display = 'none';
				    container.appendChild(suggestionsList);

				    newTextarea.addEventListener('input', function(e) {
					    const inputText = this.value.toLowerCase();
					    suggestionsList.innerHTML = '';
					    if (!suggestions.filter(suggestion => suggestion.toLowerCase().startsWith(inputText)).length) {
							suggestionsList.style.display = 'none';
						}
					    else {
					    	suggestionsList.style.display = 'block';
					    	var rect = e.currentTarget.getBoundingClientRect();
					    	//console.log(rect.top + document.body.scrollTop);
					    	suggestionsList.style.top = rect.top + window.scrollY + 15 + "px";
					    	suggestionsList.style.left = rect.left + window.scrollX + "px";
					    }
					    suggestions.filter(suggestion => suggestion.toLowerCase().startsWith(inputText)).forEach(suggestion => {
					        const li = document.createElement('li');
					        li.innerText = suggestion + " ";

					        li.addEventListener('click', function() {
					          	newTextarea.value = this.innerText + " ";
					          	newTextarea.focus();
					          	suggestionsList.style.display = 'none';
					          	autoGrowTextarea(newTextarea);
				    			saveForm(new Event("click"));
					        });
					        suggestionsList.appendChild(li);
							document.addEventListener('click', (e) => {
							  if (!newTextarea.contains(e.target)) {
							    suggestionsList.style.display = 'none';
							  }
							});
					    });
				    });
				    container.appendChild(suggestionsList);
				  };
				function autoGrowTextarea(textarea) {
				    textarea.style.height = "5px";
				    textarea.style.height = (textarea.scrollHeight) + "px";
				  }
				function deleteRow(e){
					var confirmation = confirm("–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å, –¥–∞? ü§î");
			    	if (confirmation) {
			        e.currentTarget.parentElement.parentElement.remove();
				  }
				};
				function addNewRow() {
				    const row = document.createElement("tr");
				    row.innerHTML = `
				      <td>
				        <input type="tel" id="timecode${rowNum}" name="timecode${rowNum}" maxlength="8" class="tc">
				      </td>
				      <td>
				        <textarea id="text${rowNum}" name="text${rowNum}" rows="1" oninput="autoGrowTextarea(this)" maxlength="100"></textarea>
				      </td>
				      <td><button class = "delete"><img src="{% static 'delete.png' %}" width="50px" height="50px"></button>
				      	  <button id="pauseButton"><img src="{% static 'addcode.png' %}" width="50px" height="50px"></button>
				          <button class="drag"><img src="{% static 'drag.png' %}" width="30px" height="30px"></button>
				      </td>
				    `;
				    //setupDragEvents(row);
				    const newRowInput = row.querySelector("input");
				    const newTextarea = row.querySelector("textarea");
				    setTimeout(() => {
					  newTextarea.focus();
					}, 0);
				    row.querySelector(".delete").addEventListener("click", deleteRow);
				    row.querySelector(".delete").addEventListener("click", saveForm);
				    row.querySelectorAll("#pauseButton").forEach(button => {
					    button.addEventListener("click", e => {
					      var tr = e.currentTarget.parentElement.parentElement;
					      var input = tr.querySelector("input");
					      if (input && input.value.trim().length == 0) {
					        input.value = formatTime(onYouTubeIframeAPIReady().getCurrentTime());
					      }
					      saveForm(new Event("click"));
					    });
					  });
				    newRowInput.addEventListener("keydown", e => {
				    	if(e.currentTarget.value.length == 8 || e.key === "Enter" || e.key === "Tab") {
					  		e.currentTarget.value += "";
					    	// setTimeout(() => {
						  	// 	newTextarea.focus();
							// }, 0);
							return true;
				    	}
					    if (!(e.keyCode >= 48 && e.keyCode <= 57 || e.keyCode >= 96 && e.keyCode <= 105 || e.keyCode === 8)){
					    	e.preventDefault();
					    }
				    	const regex = /^[0-9:]+$/; // —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ
				  		if(!regex.test(e.currentTarget.value)){ // –µ—Å–ª–∏ —Å–∏–º–≤–æ–ª—ã –Ω–µ —è–≤–ª—è—é—Ç—Å—è —Ü–∏—Ñ—Ä–∞–º–∏ –∏–ª–∏ –¥–≤–æ–µ—Ç–æ—á–µ–º
						    e.currentTarget.value = e.currentTarget.value.slice(0, -1); // —É–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–∏–º–≤–æ–ª –∏–∑ –∑–Ω–∞—á–µ–Ω–∏—è input
						    return false; // –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏, —á—Ç–æ–±—ã –≤–≤–µ–¥–µ–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω–µ
				  		}
						// –¥–æ–±–∞–≤–ª—è–µ–º –¥–≤–æ–µ—Ç–æ—á–∏–µ –∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ü–∏—Ñ—Ä
						if ((e.currentTarget.value.length === 2 || e.currentTarget.value.length === 5) && e.keyCode !== 8) {
						    e.currentTarget.value += ":";
				  		} else if (e.currentTarget.value.length > 8) {
				    		e.currentTarget.value = e.currentTarget.value.slice(0, 8);
				  		} else if ((e.currentTarget.value.length === 3 || e.currentTarget.value.length === 6) && e.keyCode === 8){
				    		const inputValueArray = e.currentTarget.value.split('');
				    		inputValueArray.splice(-1, 1);
				    		e.currentTarget.value = inputValueArray.join('');
				  		}
				  		return true; // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º true, —á—Ç–æ–±—ã –≤–≤–µ–¥–µ–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª –æ—Ç–æ–±—Ä–∞–∑–∏–ª—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω–µ
					}); 
				    addSuggestions(newTextarea);
				    container.appendChild(row);

				    newTextarea.addEventListener("input", function() {
				      let value = this.value;
				      if (value.length > 0) {
				        this.value = value.charAt(0).toUpperCase() + value.slice(1);
				      }
				    });
				    row.addEventListener("change", saveForm);
				    //row.addEventListener("DOMContentLoaded", qwerty);
				    qwerty();
				    //newRowInput.addEventListener("change", saveForm);
				    //newTextarea.addEventListener("change", saveForm);
				    }
				rowNum++;  	
				function saveForm(event) {
						  event.preventDefault(); // Prevent page reload
						  
						  let form = document.querySelector('form');
						  
						  let timestamps = [];
					 	  let texts = [];

					 	  document.querySelectorAll("tr").forEach(tr => {
						        let timestampInput = tr.querySelector("input");
						        let textAreaInput = tr.querySelector("textarea");
						        
						        let timestamp = timestampInput.value;
						        let text = textAreaInput.value;
						        
						        timestamps.push(timestamp);
						        texts.push(text);
						    });
						    document.querySelector("#timestamps-field").value = timestamps.join("\n");
						    document.querySelector("#texts-field").value = texts.join("\n");

						    let formData = new FormData(form);
							  formData.set('timestamps_field', timestamps.join("\n"));
							  formData.set('texts_field', texts.join("\n"));

						  // fetch(form.action, {
						  //   method: form.method,
						  //   body: formData
						  // })
						  // .then(response => {
						  //   if (response.ok) {
						  //     // Handle successful response
						  //     console.log("Form submitted successfully!");
						  //     // You can perform any additional actions here, such as updating the UI or displaying a success message
						  //   } else {
						  //     // Handle error response
						  //     console.error("Form submission failed!");
						  //   }
						  // })
						  // .catch(error => {
						  //   // Handle network or other errors
						  //   console.error("An error occurred while submitting the form:", error);
						  // });

						  document.querySelectorAll(".tc").forEach(i => {
						  	if (i.value.split(":")[0] == "00" && i.value.split(":").length == 3) {
							  	i.value = i.value.slice(3);
							  }
						  });
						}
				function incrementTime(isAddition = true) {
					  console.log("rabotaet");
					  // Get the increment value entered by the user
					  const incrementValue = document.getElementById("timeInput").value;

					  // Get all the input elements containing time values
					  var timeInputs = [...document.querySelectorAll(".tc")].slice(1);
					  var iVal = incrementValue.split(":");

					  // Iterate over each input element and increment the time value
					  for (var i = 0; i < timeInputs.length; i++) {
					  	  var tInputs = timeInputs[i].value.split(":");
					  	  
						  var seconds = "";
						  var minutes = "";
						  var hours = "";
						  var result = "";
						  var resNum = 0;
						  if (tInputs.length === 3) {
						  	result = "";
						  	seconds = tInputs[2];
						  	minutes = tInputs[1];
						  	hours = tInputs[0];
						  	if(isAddition)
							  	resNum = (parseInt(seconds) + parseInt(minutes)*60 + parseInt(hours)*3600)+(parseInt(iVal[2]) + parseInt(iVal[1])*60 + parseInt(iVal[0])*3600);
							else resNum = (parseInt(seconds) + parseInt(minutes)*60 + parseInt(hours)*3600)-(parseInt(iVal[2]) + parseInt(iVal[1])*60 + parseInt(iVal[0])*3600);
						  	result += "" + (Math.floor(resNum / 3600) > 9 ? Math.floor(resNum / 3600) : ("0"+Math.floor(resNum / 3600))) + ":" + 
						  				   (Math.floor((resNum % 3600) / 60) > 9 ? Math.floor((resNum % 3600) / 60) : ("0"+Math.floor((resNum % 3600) / 60))) + ":" + 
						  				   (((resNum % 3600) % 60) > 9 ? ((resNum % 3600) % 60) : ("0"+((resNum % 3600) % 60)));
						  	console.log(result);
						  }
						  if (tInputs.length === 2) {
						  	result = "";
						  	seconds = tInputs[1];
						  	minutes = tInputs[0];
						  	if(isAddition) resNum = (parseInt(seconds) + parseInt(minutes)*60) +(parseInt(iVal[2]) + parseInt(iVal[1])*60);
						  	else resNum = (parseInt(seconds) + parseInt(minutes)*60)-(parseInt(iVal[2]) + parseInt(iVal[1])*60);
						  	if (resNum < 0) {
						  		result = "00:00";
						  	}
						  	else{
						  		result += "" + (Math.floor(resNum / 3600) > 9 ? Math.floor(resNum / 3600) : ("0"+Math.floor(resNum / 3600))) + ":" + 
						  				   (Math.floor((resNum % 3600) / 60) > 9 ? Math.floor((resNum % 3600) / 60) : ("0"+Math.floor((resNum % 3600) / 60))) + ":" + 
						  				   (((resNum % 3600) % 60) > 9 ? ((resNum % 3600) % 60) : ("0"+((resNum % 3600) % 60)));
						  	}
						  	
						  	console.log(result);
						  }
						  timeInputs[i].value = result;
					  }
					  saveForm(new Event("click"));
				}
				function formatTime(totalSeconds) {
				  const hours = Math.floor(totalSeconds / 3600);
				  const minutes = Math.floor((totalSeconds % 3600) / 60);
				  const seconds = Math.floor(totalSeconds % 60);

				  let formattedTime = "";
				  if (hours > 0) {
				    formattedTime += padZero(hours) + ":";
				  }
				  formattedTime += padZero(minutes) + ":" + padZero(seconds);
				  return formattedTime;
				}
				function padZero(number) {
				  return number.toString().padStart(2, "0");
				}
				function qwerty() {
				  const container = document.getElementById("fields");
				  const dragButtons = document.querySelectorAll(".drag");
				  let isDragging = false;
				  let saveTimeout; // Variable to store the saveForm timeout

				  // Initialize dragula with the container
				  const drake = dragula([container], {
				    copy: false, // Disable cloning of dragged elements
				  });

				  // Create autoScroll instance
				  const scroll = autoScroll([
				    window,
				    container
				  ], {
				    margin: 20,
				    autoScroll: function() {
				      return this.down && drake.dragging;
				    }
				  });

				  // Handle drag event
				  drake.on("drag", function(el) {
				    if (isDragging) {
				      // Add the dragging class
				      el.classList.add("dragging");
				    } else {
				      // Cancel the drag operation
				      drake.cancel();
				    }
				  });

				  // Handle dragend event
				  drake.on("dragend", function(el) {
				    // Remove the dragging class
				    el.classList.remove("dragging");

				    // If dragging occurred, save the form after a delay
				    if (isDragging) {
				      clearTimeout(saveTimeout);
				      saveTimeout = setTimeout(function() {
				        saveForm(new Event("click"));
				      }, 100); // Adjust the delay as needed
				    }

				    // Set the isDragging flag to false
				    isDragging = false;
				  });

				  // Add event listeners to the drag buttons
				  dragButtons.forEach((button) => {
				    // Handle mousedown event on drag button
				    button.addEventListener("mousedown", function() {
				      // Set the isDragging flag to true
				      isDragging = true;
				    });

				    // Handle mouseup event on drag button
				    button.addEventListener("mouseup", function() {
				      // Set the isDragging flag to false
				      isDragging = false;

				      // Save the form after mouseup
				      saveForm(new Event("click"));
				    });

				    // Handle touchstart event on drag button
				    button.addEventListener("touchstart", function(event) {
				      // Prevent default touch behavior and set the isDragging flag to true
				      event.preventDefault();
				      isDragging = true;
				    });

				    // Handle touchend event on drag button
				    button.addEventListener("touchend", function() {
				      // Set the isDragging flag to false
				      isDragging = false;

				      // Save the form after touchend with a delay
				      clearTimeout(saveTimeout);
				      saveTimeout = setTimeout(function() {
				        saveForm(new Event("click"));
				      }, 100); // Adjust the delay as needed
				    });
				  });

				  // Prevent touchmove event default behavior when dragging
				  document.addEventListener("touchmove", function(event) {
				    if (isDragging) {
				      event.preventDefault();
				    }
				  }, { passive: false });
				}

				function onYouTubeIframeAPIReady() {
				    if (!player) {
				    	player = new YT.Player('player', {
							height: "250vh",
							width: "100%",
				        videoId: '{{link}}',
				        playerVars: {
				            'playsinline': 1,
				            'fs': 0,
				            'iv_load_policy': 3
				        },
				        events: {
				            'onReady': onPlayerReady,
				            'onStateChange': onPlayerStateChange
				        }
				    });
				    }
				    return player;
				}
				function onPlayerReady(event) {
				    event.target.playVideo();
				}
				function onPlayerStateChange(event) {
				    // Handle player state change events
				    // For example, you can perform actions based on the player's state
				    if (event.data === YT.PlayerState.PLAYING) {
				        console.log('Player is playing');
				    } else if (event.data === YT.PlayerState.PAUSED) {

				    } else if (event.data === YT.PlayerState.ENDED) {
				        console.log('Player has ended');
				    };
				};


				function showInputField() {
			    // Show the input field container
			    document.getElementById('inputFieldContainer').style.display = 'block';
			  }

				function updatePlayer() {
				  var youtubeLink = document.getElementById('videoInput').value;
				  var videoId = extractVideoId(youtubeLink);

				  if (player) {
				    // Update the videoId and load the new video
				    player.loadVideoById(videoId);

				    // Send the new video ID to the server
				    let form = document.querySelector('form');
				    document.querySelector("#video-Id").value = videoId;
				    let formData = new FormData(form);
				    formData.set('video_Id', videoId);


				    fetch(form.action, {
				      method: form.method,
				      body: formData
				    })
				      .then(function(response) {
				        if (response.ok) {
				          console.log('Video ID updated successfully');
				        } else {
				          console.log('Video ID update failed');
				        }
				      })
				      .catch(function(error) {
				        console.error('Error updating video ID:', error);
				      });
				  }
				  saveForm(new Event("click"));
				}


			  // Helper function to extract the videoId from YouTube link
				function extractVideoId(link) {
				  // Check if the link is in the format: https://www.youtube.com/watch?v=VIDEO_ID
				  var match = link.match(/youtube\.com\/watch\?v=([^&]+)/);
				  if (match) {
				    return match[1];
				  }

				  // Check if the link is in the format: https://youtu.be/VIDEO_ID
				  match = link.match(/youtu\.be\/([^?]+)/);
				  if (match) {
				    return match[1];
				  }

				  // Check if the link is in the format: https://www.youtube.com/live/VIDEO_ID
				  match = link.match(/youtube\.com\/live\/([^?]+)/);
				  if (match) {
				    return match[1];
				  }

				  // If no match is found, return null or handle the error as needed
				  return null;
				}
		</script>
	{% endif %}
</body>
</html>